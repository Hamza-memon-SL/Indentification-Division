IDENTIFICATION DIVISION.
PROGRAM-ID. TRANSACTION-PROCESSOR.

ENVIRONMENT DIVISION.
INPUT-OUTPUT SECTION.
FILE-CONTROL.
    SELECT INTRANOL ASSIGN TO INTRANOL.
    SELECT INTRANCS ASSIGN TO INTRANCS.
    SELECT INTRANIV ASSIGN TO INTRANIV.
    SELECT INMASTFL ASSIGN TO INMASTFL.
    SELECT OUTMASTFL ASSIGN TO OUTMASTFL.
    SELECT SUMMARY-FILE ASSIGN TO OUTSUMFL.

DATA DIVISION.
FILE SECTION.
FD INTRANOL.
01 INTRANOL-REC.
   05 ACCT-NO        PIC 9(16) COMP-3.  * Packed Decimal
   05 TRAN-CODE      PIC X(4).
   05 TRAN-AMOUNT    PIC S9(9)V99.
   05 TRAN-TIME      PIC X(14).  * Format: YYYYMMDDHHMMSS
   05 TRAN-SUMMARY   PIC X(50).

FD INTRANCS.
01 INTRANCS-REC.
   05 ACCT-NO        PIC 9(16) COMP-3.  * Packed Decimal
   05 TRAN-CODE      PIC X(4).
   05 TRAN-AMOUNT    PIC S9(9)V99.
   05 TRAN-TIME      PIC X(14).
   05 TRAN-SUMMARY   PIC X(50).

FD INTRANIV.
01 INTRANIV-REC.
   05 ACCT-NO        PIC 9(16) COMP-3.  * Packed Decimal
   05 TRAN-CODE      PIC X(4).
   05 TRAN-AMOUNT    PIC S9(9)V99.
   05 TRAN-TIME      PIC X(14).
   05 TRAN-SUMMARY   PIC X(50).

FD INMASTFL.
01 INMASTFL-REC.
   05 ACCT-NO        PIC 9(16) COMP-3.  * Packed Decimal
   05 ACCT-BALANCE   PIC S9(9)V99.
   05 ACCT-NAME      PIC X(30).
   05 TRAN-SOURCE    PIC X(20).
   05 LAST-TRAN-TIME PIC X(14).

FD OUTMASTFL.
01 OUTMASTFL-REC.
   05 ACCT-NO        PIC 9(16) COMP-3.  * Packed Decimal
   05 ACCT-BALANCE   PIC S9(9)V99.
   05 ACCT-NAME      PIC X(30).
   05 TRAN-SOURCE    PIC X(20).
   05 LAST-TRAN-TIME PIC X(14).

FD SUMMARY-FILE.
01 SUMMARY-REC.
   05 TOTAL-FI-COUNT    PIC 9(8) VALUE 0.
   05  FILLER 		  PIC X(2) VALUE SPACES.
   05 TOTAL-DE-COUNT    PIC 9(8) VALUE 0.
   05  FILLER 		  PIC X(2) VALUE SPACES.
   05 TOTAL-ONL-COUNT   PIC 9(8) VALUE 0.
   05  FILLER 		  PIC X(2) VALUE SPACES.
   05 TOTAL-CUS-COUNT   PIC 9(8) VALUE 0.
   05  FILLER 		  PIC X(2) VALUE SPACES.
   05 TOTAL-IVR-COUNT   PIC 9(8) VALUE 0.
   05  FILLER 		  PIC X(2) VALUE SPACES.
   05 TOTAL-INMASTER    PIC 9(8) VALUE 0.
   05  FILLER 		  PIC X(2) VALUE SPACES.
   05 TOTAL-OUTMASTER   PIC 9(8) VALUE 0.
   05  FILLER 		  PIC X(2) VALUE SPACES. 
   05 TOTAL-OTHER-COUNT PIC 9(8) VALUE 0.

WORKING-STORAGE SECTION.
01 WS-TOTAL-FI        PIC 9(8) VALUE 0.
01 WS-TOTAL-DE        PIC 9(8) VALUE 0.
01 WS-CUS-COUNT       PIC 9(8) VALUE 0.
01 WS-ONL-COUNT       PIC 9(8) VALUE 0.
01 WS-IVR-COUNT       PIC 9(8) VALUE 0.
01 WS-INMST-CNT       PIC 9(8) VALUE 0.
01 WS-OUTMST-CNT      PIC 9(8) VALUE 0.
01 WS-TOTAL-OTHER     PIC 9(8) VALUE 0.
01 WS-OTHER-LIMIT     PIC 9(8) VALUE 0.
01 WS-TRANSACTION-CODE PIC X(4).
01 WS-TRAN-TIME       PIC X(14).
01 WS-TRAN-SOURCE     PIC X(20).
01 WS-LATEST-TIME     PIC X(14).
01 WS-EOF             PIC X VALUE 'N'.

PROCEDURE DIVISION.
MAIN-PROCESS.
    PERFORM INITIALIZATION.
    PERFORM PROCESS-FILES UNTIL WS-EOF = 'Y'.
    PERFORM WRITE-SUMMARY.
    STOP RUN.

INITIALIZATION.
    OPEN INPUT INTRANOL INTRANCS INTRANIV INMASTFL
         OUTPUT OUTMASTFL SUMMARY-FILE.

PROCESS-FILES.
    READ INTRANOL INTO INTRANOL-REC
        AT END MOVE 'Y' TO WS-EOF.
    IF WS-EOF = 'N'
        MOVE INTRANOL-REC TO TRAN-REC
        PERFORM MATCH-MASTER-ACCOUNT
        IF MATCH-FOUND = 'Y'
            PERFORM PROCESS-TRANSACTION
            ADD 1 TO WS-ONL-COUNT
        END-IF
    END-IF.

    READ INTRANCS INTO INTRANCS-REC
        AT END MOVE 'Y' TO WS-EOF.
    IF WS-EOF = 'N'
        MOVE INTRANCS-REC TO TRAN-REC
        PERFORM MATCH-MASTER-ACCOUNT
        IF MATCH-FOUND = 'Y'
            PERFORM PROCESS-TRANSACTION
            ADD 1 TO WS-CUS-COUNT
        END-IF
    END-IF.

    READ INTRANIV INTO INTRANIV-REC
        AT END MOVE 'Y' TO WS-EOF.
    IF WS-EOF = 'N'
        MOVE INTRANIV-REC TO TRAN-REC
        PERFORM MATCH-MASTER-ACCOUNT
        IF MATCH-FOUND = 'Y'
            PERFORM PROCESS-TRANSACTION
            ADD 1 TO WS-IVR-COUNT
        END-IF
    END-IF.

MATCH-MASTER-ACCOUNT.
    MOVE 'N' TO MATCH-FOUND.
    PERFORM UNTIL WS-EOF = 'Y'
        READ INMASTFL INTO INMASTFL-REC
            AT END MOVE 'Y' TO WS-EOF
            NOT AT END
                IF ACCT-NO OF TRAN-REC = ACCT-NO OF INMASTFL-REC
                    MOVE 'Y' TO MATCH-FOUND
                    EXIT PERFORM
                END-IF
        END-READ
    END-PERFORM.

PROCESS-TRANSACTION.
    MOVE TRAN-CODE OF TRAN-REC TO WS-TRANSACTION-CODE.
    MOVE TRAN-TIME OF TRAN-REC TO WS-TRAN-TIME.

    IF WS-TRANSACTION-CODE(1:2) = 'FI'
        ADD 1 TO WS-TOTAL-FI
        IF WS-TRANSACTION-CODE = 'FIPY'
            ADD TRAN-AMOUNT OF TRAN-REC TO ACCT-BALANCE OF INMASTFL-REC
            MOVE 'ONLINE' TO TRAN-SOURCE OF INMASTFL-REC
            MOVE WS-TRAN-TIME TO LAST-TRAN-TIME OF INMASTFL-REC
        END-IF
    ELSE IF WS-TRANSACTION-CODE(1:2) = 'DE'
        ADD 1 TO WS-TOTAL-DE
        PERFORM APPLY-DEMOGRAPHIC
    ELSE
        ADD 1 TO WS-TOTAL-OTHER
    END-IF.

    PERFORM CHECK-OTHER-TRANSACTION.

CHECK-OTHER-TRANSACTION.
    COMPUTE WS-OTHER-LIMIT = 0.2 * (WS-TOTAL-FI + WS-TOTAL-DE).
    IF WS-TOTAL-OTHER > WS-OTHER-LIMIT
        DISPLAY 'ABEND: OTHER TRANSACTIONS EXCEED 20%'
        STOP RUN
    END-IF.

APPLY-DEMOGRAPHIC.
    IF WS-TRAN-TIME > LAST-TRAN-TIME OF INMASTFL-REC
        MOVE TRAN-AMOUNT OF TRAN-REC TO ACCT-BALANCE OF INMASTFL-REC
        MOVE 'ONLINE' TO TRAN-SOURCE OF INMASTFL-REC
        MOVE WS-TRAN-TIME TO LAST-TRAN-TIME OF INMASTFL-REC
    END-IF.

WRITE-SUMMARY.
    MOVE WS-TOTAL-FI TO TOTAL-FI-COUNT OF SUMMARY-REC.
    MOVE WS-TOTAL-DE TO TOTAL-DE-COUNT OF SUMMARY-REC.
    MOVE WS-TOTAL-OTHER TO TOTAL-OTHER-COUNT OF SUMMARY-REC.
    WRITE SUMMARY-REC.

FINALIZATION.
    CLOSE INTRANOL INTRANCS INTRANIV INMASTFL
          OUTMASTFL SUMMARY-FILE.
    DISPLAY 'PROCESSING COMPLETED SUCCESSFULLY'.

END-MAIN.
    STOP RUN.